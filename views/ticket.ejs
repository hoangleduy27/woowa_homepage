<!DOCTYPE html>
<html lang="en">

<head>
  <title>Title</title>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <!-- Bootstrap CSS v5.2.1 -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css"
    integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ" crossorigin="anonymous" />
  <link rel="stylesheet" href="/styles/seatinghall.css" />
</head>
<%- include('headerPartial') %>

  <body>
    <div class="m-4">
      <div class="mb-3">Vui lòng chọn ghế bên dưới</div>
      <div class="row">
        <div class="col-md-9 col-12">
          <div class="noted row mx-0 mb-4">
            <div class="">
              <div class="row">
                <div class="col-12 col-md-6 noted-item">
                  <div class="d-flex">
                    <div class="vvip-color noted-colorbox"></div>
                    <div class="ms-3">
                      <div class="noted-text">Khu A</div>
                      <div>30 lượt</div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6 noted-item">
                  <div class="d-flex">
                    <div class="vip-color noted-colorbox"></div>
                    <div class="ms-3">
                      <div class="noted-text">Khu B</div>
                      <div>25 lượt</div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6 noted-item">
                  <div class="d-flex">
                    <div class="standard-color noted-colorbox"></div>
                    <div class="ms-3">
                      <div class="noted-text">Khu C</div>
                      <div>20 lượt</div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6 noted-item">
                  <div class="d-flex">
                    <div class="zone1-color noted-colorbox"></div>
                    <div class="ms-3">
                      <div class="noted-text">Khu D</div>
                      <div>17 lượt</div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6 noted-item">
                  <div class="d-flex">
                    <div class="zone2-color noted-colorbox"></div>
                    <div class="ms-3">
                      <div class="noted-text">Khu E</div>
                      <div>13 lượt</div>
                    </div>
                  </div>
                </div>
                <!-- <div class="col-12 col-md-6 noted-item">
                                <div class="d-flex">
                                    <div class="zone2-color noted-colorbox"></div>
                                    <div class="ms-3">
                                        <div class="noted-text">ZONE 2</div>
                                        <div>13 lượt</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6 noted-item">
                                <div class="d-flex">
                                    <div class="zone3-color noted-colorbox"></div>
                                    <div class="ms-3">
                                        <div class="noted-text">ZONE 3</div>
                                        <div>10 lượt</div>
                                    </div>
                                </div>
                            </div> -->
              </div>
            </div>
          </div>
          <div class="seats-map">
            <div class="mb-4">
              <div class="screen m-auto">SÂN KHẤU/STAGE</div>
            </div>
            <div class="d-flex justify-content-around">
              <div class="seats-l-zone3 zone1-color row position-relative" id="D">
                <span class="position-absolute text-white fw-bold fs-2 fs-xs-6 text-uppercase">Khu D</span>
                <div class="marquee-text">
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> D&nbsp;</span>
                    <span class="rotate-text"> D&nbsp;</span>
                    <span class="rotate-text"> D&nbsp;</span>
                    <span class="rotate-text"> D&nbsp;</span>
                  </div>
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> D&nbsp;</span>
                    <span class="rotate-text"> D&nbsp;</span>
                    <span class="rotate-text"> D&nbsp;</span>
                    <span class="rotate-text"> D&nbsp;</span>
                  </div>
                </div>
                <!-- <div class="seat">1</div>
                            <div class="seat">2</div>
                            <div class="seat">3</div>
                            <div class="seat">4</div>
                            <div class="seat">5</div> -->
              </div>
              <div class="seats-l-zone3 standard-color row position-relative" id="C">
                <span class="text-white fw-bold fs-2 fs-xs-6 position-absolute text-uppercase">Khu C</span>
                <div class="marquee-text">
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> C&nbsp;</span>
                    <span class="rotate-text"> C&nbsp;</span>
                    <span class="rotate-text"> C&nbsp;</span>
                  </div>
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> C&nbsp;</span>
                    <span class="rotate-text"> C&nbsp;</span>
                    <span class="rotate-text"> C&nbsp;</span>
                  </div>
                </div>
              </div>
              <div class="seats-l-zone3 vvip-color row position-relative" id="A">
                <span class="text-white fw-bold fs-2 fs-xs-6 position-absolute text-uppercase">Khu A</span>
                <div class="marquee-text">
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> A&nbsp;</span>
                    <span class="rotate-text"> A&nbsp;</span>
                    <span class="rotate-text"> A&nbsp;</span>
                    <span class="rotate-text"> A&nbsp;</span>
                  </div>
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> A&nbsp;</span>
                    <span class="rotate-text"> A&nbsp;</span>
                    <span class="rotate-text"> A&nbsp;</span>
                    <span class="rotate-text"> A&nbsp;</span>
                  </div>
                </div>
              </div>
              <div class="seats-l-zone3 vip-color row position-relative" id="B">
                <span class="text-white fw-bold fs-2 fs-xs-6 position-absolute text-uppercase">Khu B</span>
                <div class="marquee-text">
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> B&nbsp;</span>
                    <span class="rotate-text"> B&nbsp;</span>
                    <span class="rotate-text"> B&nbsp;</span>
                    <span class="rotate-text"> B&nbsp;</span>
                  </div>
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> B&nbsp;</span>
                    <span class="rotate-text"> B&nbsp;</span>
                    <span class="rotate-text"> B&nbsp;</span>
                    <span class="rotate-text"> B&nbsp;</span>
                  </div>
                </div>
              </div>
              <div class="seats-l-zone3 zone2-color row position-relative" id="E">
                <span class="text-white fw-bold fs-2 fs-xs-6 position-absolute text-uppercase">Khu E</span>
                <div class="marquee-text">
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> E&nbsp;</span>
                    <span class="rotate-text"> E&nbsp;</span>
                    <span class="rotate-text"> E&nbsp;</span>
                    <span class="rotate-text"> E&nbsp;</span>
                  </div>
                  <div class="rotate-marquee-text">
                    <span class="rotate-text"> E&nbsp;</span>
                    <span class="rotate-text"> E&nbsp;</span>
                    <span class="rotate-text"> E&nbsp;</span>
                    <span class="rotate-text"> E&nbsp;</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-3 pt-4 pt-md-0">
          <div class="info-area" id="info-area">
            <div class="info-area-title">Thông tin đặt vé</div>

            <div class="py-2" id="area-selected-alert">Vui lòng chọn vé</div>
            <div class="d-none" id="area-detail-list">
              <div class="info-area-subtitle">
                <div>Loại vé</div>
                <div>Số lượng</div>
              </div>
              <div id="area-ticket-detail">
                <div class="py-2">
                  <div class="area-name fw-bold">Khu A</div>
                  <div class="d-flex justify-content-between">
                    <div class="area-price">50 lượt</div>
                    <div class="area-quantity">1</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- <div class="area-sum-info">
                    <div>Tổng cộng</div>
                    <div id="sumary-point">50 lượt</div>
                </div> -->
          <div class="mt-3">
            <% if (user.ticket==='yes' ) { %>
              <button id="ticket-exchange-button" class="w-100 btn btn-lg btn-warning fw-bold disabled" disabled>
                Bạn đã có vé
              </button>
              <% } else { %>
                <button id="ticket-exchange-button" class="w-100 btn btn-lg btn-success fw-bold disabled">
                  Đổi vé
                </button>
                <% } %>

          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
      integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
      crossorigin="anonymous"></script>

    <!-- <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js"
      integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz"
      crossorigin="anonymous"
    ></script> -->
    <script defer src="https://use.fontawesome.com/releases/v5.1.1/js/all.js"
      integrity="sha384-BtvRZcyfv4r0x/phJt9Y9HhnN5ur1Z+kZbKVgzVBAlQZX4jvAuImlIz+bG7TS00a"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.all.min.js"></script>

    <script type="text/javascript">

      // Dữ liệu của khu vực vé
      const areas = {
        "A": { shared: 30, name: "Khu A", color: "vvip-text-color" },
        "B": { shared: 25, name: "Khu B", color: "vip-text-color" },
        "C": { shared: 20, name: "Khu C", color: "standard-text-color" },
        "D": { shared: 17, name: "Khu D", color: "zone1-text-color" },
        "E": { shared: 13, name: "Khu E", color: "zone2-text-color" },
      };
      let areas_selected = [];
      const user_shared = "<%= user.referral_code_count %>";


      const area_zone = document.querySelectorAll('.seats-l-zone3');
      area_zone.forEach(area => {
        area.addEventListener('click', e => {
          if (e.currentTarget.classList.contains('seats-l-zone3') && !e.currentTarget.classList.contains('disabled')) {
            // if (e.currentTarget.classList.contains('selected')) {
            //     areas_selected.splice(areas_selected.indexOf(e.currentTarget.id), 1);
            //     updateAreaInfo(areas_selected);
            //     e.currentTarget.classList.toggle('selected');
            // } else {
            $(".seats-map").find(".selected").removeClass("selected");
            areas_selected = [e.currentTarget.id];
            updateAreaInfo(areas_selected);
            e.currentTarget.classList.toggle('selected');
            // }
          }
        });
      })

      function updateAreaInfo(params) {
        // console.log(params);
        if (params?.length <= 0 || params === undefined) {
          $("#area-selected-alert").removeClass("d-none");
          $("#area-detail-list").addClass("d-none");
          $("#ticket-exchange-button").addClass("disabled");
        } else {
          $("#area-selected-alert").addClass("d-none");
          $("#area-detail-list").removeClass("d-none");

          let detail_list = "";
          params.forEach(param => {
            let warning_text = "";
            if (user_shared < areas[param].shared) {
              $("#ticket-exchange-button").addClass("disabled");
              warning_text = `<small class="text-danger">Cần thêm <b>${areas[param].shared - user_shared} lượt chia sẻ</b> để đổi vé ${areas[param].name}</small>`
            } else $("#ticket-exchange-button").removeClass("disabled");

            detail_list += `
                      <div class="py-2">
                          <div class="area-name fw-bold ${areas[param].color}">${areas[param].name}</div>
                          <div class="d-flex justify-content-between">
                              <div class="area-price">${areas[param].shared} lượt</div>
                              <div class="area-quantity">1</div>
                          </div>
                          ${warning_text}
                      </div>
                  `;
          })
          $("#area-ticket-detail").html(detail_list);
        }
      }
    </script>
    <% if( user.ticket !='yes' ) { %>

      <script>
        document.getElementById("ticket-exchange-button").addEventListener("click", async () => {
          if (!$("#ticket-exchange-button").hasClass("disabled")) {
            const selectedAreas = areas_selected;
            console.log(selectedAreas);
            if (selectedAreas.length > 0) {
              Swal.fire({
                title: "Xác nhận đổi vé",
                text: "Bạn có chắc muốn đổi vé không?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Đổi vé",
                cancelButtonText: "Hủy bỏ",
              }).then(async (result) => {
                if (result.isConfirmed) {
                  try {
                    console.log(JSON.stringify(selectedAreas));
                    const response = await fetch("/redeem-gift", {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify(selectedAreas),
                    });

                    const responseData = await response.json();
                    // Xử lý thông báo hoặc tác vụ khác dựa trên dữ liệu phản hồi
                    console.log(responseData);
                    if (response.status === 200 && responseData.message) {
                      console.log(responseData.message); // "Đổi vé thành công và đã gửi email xác nhận."
                      // Reload lại trang sau khi đổi vé thành công
                      window.location.href = "/events?redeemmessage=success";


                    } else {
                      console.log("Đổi vé không thành công.");
                    }
                  } catch (error) {
                    console.error("Error:", error);
                    console.log("Đã xảy ra lỗi khi đổi vé.");
                  }
                }
              });
            }
          }
        });

      </script>
      <% } %>


  </body>

</html>